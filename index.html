<script>
(function(){
  // =========================
  // 1) LINKS DO MERCADO PAGO (um por pacote)
  // =========================
  const MP_LINKS = {
    1: "https://mpago.li/2DrujAy",
    2: "https://mpago.li/2za2eDc",
    3: "https://mpago.li/1gm7Bhc"
  };

  const WHATS_NUMBER = "5514991856520";

  function isValidMpLink(url){
    return typeof url === "string" && url.startsWith("http");
  }

  function getMpLinkByPack(pack){
    const p = Number(pack);
    const link = MP_LINKS[p];
    return isValidMpLink(link) ? link : "";
  }

  function openPay(pack){
    const link = getMpLinkByPack(pack);
    if(link){
      window.open(link, "_blank", "noopener");
      return true;
    }
    return false;
  }

  // ===== MENU MOBILE =====
  const menuBtn = document.getElementById('menuBtn');
  const panel = document.getElementById('mobilePanel');
  const desktopLinks = Array.from(document.querySelectorAll('nav.nav-desktop a'));
  const mobileLinks  = Array.from(panel.querySelectorAll('.inner > a'));

  function setActive(hash){
    const all = desktopLinks.concat(mobileLinks);
    all.forEach(a => a.classList.toggle('active', a.getAttribute('href') === hash));
  }

  function closeMenu(){
    panel.style.display = 'none';
    menuBtn.setAttribute('aria-expanded','false');
    menuBtn.setAttribute('aria-label','Abrir menu');
  }

  function toggleMenu(){
    const open = panel.style.display === 'block';
    if(open) closeMenu();
    else{
      panel.style.display = 'block';
      menuBtn.setAttribute('aria-expanded','true');
      menuBtn.setAttribute('aria-label','Fechar menu');
    }
  }

  menuBtn.addEventListener('click', toggleMenu);
  mobileLinks.forEach(a=>{
    a.addEventListener('click', ()=>{
      setActive(a.getAttribute('href'));
      closeMenu();
    });
  });
  desktopLinks.forEach(a=>{
    a.addEventListener('click', ()=> setActive(a.getAttribute('href')));
  });
  window.addEventListener('scroll', ()=>{
    if(panel.style.display === 'block') closeMenu();
  }, {passive:true});
  window.addEventListener('resize', ()=>{
    if(window.innerWidth > 980) closeMenu();
  });

  if(location.hash){ setActive(location.hash); }

  // ===== ANIMAÇÕES SUAVES (SCROLL REVEAL) =====
  const items = document.querySelectorAll('.reveal');
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        e.target.classList.add('show');
        io.unobserve(e.target);
      }
    });
  }, {threshold: 0.12});
  items.forEach(el=> io.observe(el));

  // ===== ATIVO NO MENU PELO SCROLL =====
  const sectionIds = ['inicio','sobre','servicos','pacotes','portfolio','depoimentos','contato'];
  const sections = sectionIds.map(id => document.getElementById(id)).filter(Boolean);

  const navIO = new IntersectionObserver((entries)=>{
    const visible = entries
      .filter(e => e.isIntersecting)
      .sort((a,b)=> b.intersectionRatio - a.intersectionRatio)[0];

    if(visible && visible.target && visible.target.id){
      setActive('#' + visible.target.id);
    }
  }, {threshold: [0.25, 0.35, 0.5, 0.65]});

  sections.forEach(s => navIO.observe(s));

  // ===== PACOTES -> FORMULÁRIO =====
  const packSummary = document.getElementById('packSummary');
  const packSelect  = document.getElementById('pacote');
  const btns = Array.from(document.querySelectorAll('[data-pack]'));

  function formatBRL(value){
    const n = Number(value || 0);
    return n.toLocaleString('pt-BR', {minimumFractionDigits: 0});
  }

  function updateSummary(html){
    if(packSummary) packSummary.innerHTML = html;
  }

  btns.forEach(b=>{
    b.addEventListener('click', ()=>{
      const pack = b.getAttribute('data-pack');
      const name = b.getAttribute('data-packname');
      const price = b.getAttribute('data-price');

      if(pack === "1") packSelect.value = "Pacote 1 - R$ 697";
      if(pack === "2") packSelect.value = "Pacote 2 - R$ 997";
      if(pack === "3") packSelect.value = "Pacote 3 - R$ 1.497";

      updateSummary(`<b>${name} selecionado</b> — Valor: <b>R$ ${formatBRL(price)}</b>. Agora complete as etapas abaixo e envie seu pedido.`);
      updateSteps();
    });
  });

  // ===== BOTÕES "PAGAR AGORA" NOS PACOTES =====
  const payBtns = Array.from(document.querySelectorAll('[data-pay]'));
  payBtns.forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      const pack = btn.getAttribute('data-pay');

      const opened = openPay(pack);
      if(!opened){
        const msg = "Olá TIMP! Quero pagar o " + (pack === "1" ? "Pacote 1" : pack === "2" ? "Pacote 2" : "Pacote 3") + ". Pode me enviar o link de pagamento?";
        window.open("https://wa.me/" + WHATS_NUMBER + "?text=" + encodeURIComponent(msg), "_blank", "noopener");
      }
    });
  });

  // ===== UPLOAD UI (arquivo + remover) =====
  const arquivoInput = document.getElementById('arquivo');
  const arquivoPick  = document.getElementById('arquivoPick');
  const arquivoClear = document.getElementById('arquivoClear');
  const arquivoName  = document.getElementById('arquivoName');

  const imagemInput = document.getElementById('imagem');
  const imagemPick  = document.getElementById('imagemPick');
  const imagemClear = document.getElementById('imagemClear');
  const imagemName  = document.getElementById('imagemName');

  function setFileState(input, nameEl, clearBtn, emptyText){
    const has = input.files && input.files.length > 0;
    if(has){
      nameEl.textContent = input.files[0].name;
      clearBtn.disabled = false;
    }else{
      nameEl.textContent = emptyText;
      clearBtn.disabled = true;
    }
    updateSteps();
  }

  if(arquivoPick) arquivoPick.addEventListener('click', ()=> arquivoInput.click());
  if(arquivoInput) arquivoInput.addEventListener('change', ()=> setFileState(arquivoInput, arquivoName, arquivoClear, 'Nenhum arquivo selecionado'));
  if(arquivoClear) arquivoClear.addEventListener('click', ()=>{
    arquivoInput.value = '';
    setFileState(arquivoInput, arquivoName, arquivoClear, 'Nenhum arquivo selecionado');
  });

  if(imagemPick) imagemPick.addEventListener('click', ()=> imagemInput.click());
  if(imagemInput) imagemInput.addEventListener('change', ()=> setFileState(imagemInput, imagemName, imagemClear, 'Nenhuma imagem selecionada'));
  if(imagemClear) imagemClear.addEventListener('click', ()=>{
    imagemInput.value = '';
    setFileState(imagemInput, imagemName, imagemClear, 'Nenhuma imagem selecionada');
  });

  // ===== ETAPAS (visual) =====
  const s1 = document.getElementById('s1');
  const s2 = document.getElementById('s2');
  const s3 = document.getElementById('s3');
  const s4 = document.getElementById('s4');

  const form = document.getElementById('timpForm');
  const texto = document.getElementById('texto');
  const formError = document.getElementById('formError');

  const paySheet = document.getElementById('paySheet');
  const payNowBtn = document.getElementById('payNowBtn');
  const whatsConfirmBtn = document.getElementById('whatsConfirmBtn');

  function hasOrigem(){
    return !!form.querySelector('input[name="origem"]:checked');
  }
  function hasDadosMin(){
    const nome = (document.getElementById('nome').value || '').trim().length > 0;
    const nasc = (document.getElementById('nascimento').value || '').trim().length > 0;
    const end  = (document.getElementById('endereco').value || '').trim().length > 0;
    const cid  = (document.getElementById('cidade').value || '').trim().length > 0;
    const est  = (document.getElementById('estado').value || '').trim().length > 0;
    const cep  = (document.getElementById('cep').value || '').trim().length > 0;
    const wha  = (document.getElementById('whats').value || '').trim().length > 0;
    return nome && nasc && end && cid && est && cep && wha;
  }

  function updateSteps(){
    if(!s1 || !s2 || !s3 || !s4 || !packSelect) return;

    const ok1 = !!packSelect.value;
    s1.classList.toggle('done', ok1);
    s1.classList.toggle('active', !ok1);

    const ok2 = hasOrigem();
    s2.classList.toggle('done', ok2);
    s2.classList.toggle('active', ok1 && !ok2);

    const hasText = (texto.value || "").trim().length > 0;
    const hasFile = (arquivoInput.files && arquivoInput.files.length > 0);
    const ok3 = hasText || hasFile;
    s3.classList.toggle('done', ok3);
    s3.classList.toggle('active', ok1 && ok2 && !ok3);

    const ok4 = hasDadosMin();
    s4.classList.toggle('done', ok4);
    s4.classList.toggle('active', ok1 && ok2 && ok3 && !ok4);
  }

  if(form){
    ['change','keyup','blur'].forEach(evt=>{
      form.addEventListener(evt, updateSteps, true);
    });
  }
  updateSteps();

  // ===== SUBMIT: MOSTRA MINI CHECKOUT + WHATS =====
  if(form){
    form.addEventListener('submit', (e)=>{
      if(formError) formError.classList.remove('show');

      if(!packSelect.value){
        e.preventDefault();
        if(formError) formError.classList.add('show');
        packSelect.focus();
        return;
      }

      if(!hasOrigem()){
        e.preventDefault();
        if(formError) formError.classList.add('show');
        const firstRadio = form.querySelector('input[name="origem"]');
        if(firstRadio) firstRadio.focus();
        return;
      }

      const hasText = (texto.value || "").trim().length > 0;
      const hasFile = (arquivoInput.files && arquivoInput.files.length > 0);
      if(!hasText && !hasFile){
        e.preventDefault();
        if(formError) formError.classList.add('show');
        texto.focus();
        return;
      }

      const requiredFields = Array.from(form.querySelectorAll('[required]'));
      const missing = requiredFields.find(el=>{
        if(el.type === 'radio') return false;
        return !el.value;
      });
      if(missing){
        e.preventDefault();
        if(formError) formError.classList.add('show');
        missing.focus();
        return;
      }

      e.preventDefault();

      const origem = (form.querySelector('input[name="origem"]:checked') || {}).value || '';
      const nome = (document.getElementById('nome').value || '').trim();
      const cidade = (document.getElementById('cidade').value || '').trim();
      const estado = (document.getElementById('estado').value || '').trim();

      const msg =
`Olá TIMP! Quero iniciar meu projeto.
• Pacote: ${packSelect.value}
• Eu já tenho: ${origem}
• Nome: ${nome}
• Cidade/UF: ${cidade}/${estado}

Acabei de enviar os dados pelo site. Podemos confirmar os detalhes?`;

      const waUrl = "https://wa.me/" + WHATS_NUMBER + "?text=" + encodeURIComponent(msg);
      if(whatsConfirmBtn) whatsConfirmBtn.href = waUrl;

      // define botão de pagar agora conforme pacote selecionado
      let packNum = 0;
      if(packSelect.value.includes("Pacote 1")) packNum = 1;
      if(packSelect.value.includes("Pacote 2")) packNum = 2;
      if(packSelect.value.includes("Pacote 3")) packNum = 3;

      const payLink = getMpLinkByPack(packNum);
      if(payNowBtn){
        if(payLink){
          payNowBtn.href = payLink;
          payNowBtn.textContent = "Pagar agora (Mercado Pago)";
        }else{
          payNowBtn.href = waUrl;
          payNowBtn.textContent = "Pedir link de pagamento (WhatsApp)";
        }
      }

      if(paySheet){
        paySheet.classList.add('show');
        paySheet.scrollIntoView({behavior:"smooth", block:"center"});
      }
    });
  }

})();
</script>
